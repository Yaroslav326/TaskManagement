<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Личный кабинет</title>
    {% load static %}
    <link rel="stylesheet" href="{% static 'css/styles.css' %}">
</head>
<body>
<!-- Верхняя шапка с навигацией -->
<header class="main-header">
    <div class="nav-links">
        <a href="/" class="btn btn-secondary">Главная страница</a>
        <a href="#" onclick="showMyTasks(event)" class="btn btn-primary">Мои задачи</a>
        <a href="#" onclick="showMyDepartment(event)" class="btn btn-secondary">Моё подразделение</a>
        <a href="#" onclick="openProfileModal(event)" class="btn btn-secondary">Редактировать профиль</a>
    </div>
    <div class="user-controls" id="auth-header">
        <!-- Имя пользователя и кнопка Войти/Выйти -->
    </div>
</header>

<!-- Фильтры (скрыты до нажатия "Мои задачи") -->
<div class="filters" id="filters-section" style="display: none;">
    <form method="get">
        <label for="status-filter">Статус:</label>
        <select name="status" id="status-filter">
            <option value="">Все</option>
            {% for status in status_choices %}
                <option value="{{ status.0 }}" {% if request.GET.status == status.0 %}selected{% endif %}>
                    {{ status.1 }}
                </option>
            {% endfor %}
        </select>

        <label for="start-date">Дата начала:</label>
        <input type="date" name="start_date" id="start-date" value="{{ request.GET.start_date }}">

        <label for="end-date">Дата окончания:</label>
        <input type="date" name="end_date" id="end-date" value="{{ request.GET.end_date }}">

        <button type="button" onclick="applyFilters()">Применить</button>
    </form>
</div>

<!-- Сообщение, пока задачи не загружены -->
<div id="welcome-message" style="text-align: center; margin-top: 100px; color: #777;">
    <h2>Добро пожаловать!</h2>
    <p>Нажмите <strong>"Мои задачи"</strong>, чтобы посмотреть свои задачи.</p>
</div>

<!-- Доска задач (изначально скрыта) -->
<div class="board" id="tasks-board" style="display: none;">
    <!-- Задачи будут загружены через JS -->
</div>

<!-- Форма добавления новой задачи -->
<div class="add-task" id="add-task-section" style="display: none;">
    <h3>Добавить задачу</h3>
    <input type="text" id="task-title" placeholder="Название задачи..." />
    <button onclick="addTask()">Добавить</button>
</div>

<!-- Модальное окно для редактирования профиля -->
<div id="profile-modal" class="modal" style="display: none;">
    <div class="modal-content">
        <h3>Редактировать профиль</h3>
        <form id="profile-form">
            <label>Имя пользователя:</label>
            <input type="text" id="modal-username" required />

            <label>Email:</label>
            <input type="email" id="modal-email" required />

            <label>Новый пароль (оставьте пустым, если не меняете):</label>
            <input type="password" id="modal-password" />

            <div class="modal-buttons">
                <button type="submit">Сохранить</button>
                <button type="button" onclick="closeModal()">Отмена</button>
            </div>
        </form>
    </div>
</div>

<script src="{% static 'js/utils.js' %}"></script>

<script>
    // === Показать "Мои задачи" ===
    function showMyTasks(event) {
        event.preventDefault();
        document.getElementById('welcome-message').style.display = 'none';
        document.getElementById('filters-section').style.display = 'block';
        document.getElementById('tasks-board').style.display = 'flex';
        document.getElementById('add-task-section').style.display = 'block';
        loadMyTasks();
    }

    function showMyDepartment(event) {
        event.preventDefault();
        alert("Функция 'Моё подразделение' пока в разработке.");
    }

    // === Загрузка задач с фильтрами ===
    function loadMyTasks(filters = {}) {
        const board = document.getElementById('tasks-board');
        board.innerHTML = '<p style="text-align: center;">Загрузка задач...</p>';

        const token = localStorage.getItem('token');
        if (!token) {
            board.innerHTML = '<p style="color: red;">Ошибка: токен не найден.</p>';
            return;
        }

        fetch('/account/my-tasks/', {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify(filters)
        })
        .then(response => {
            if (response.status === 401) throw new Error('Неавторизован');
            return response.json();
        })
        .then(data => {
            if (data.html) {
                board.innerHTML = data.html;
            } else if (data.error) {
                board.innerHTML = `<p style="color: red;">Ошибка: ${data.error}</p>`;
            }
        })
        .catch(err => {
            board.innerHTML = `<p style="color: red;">${err.message}</p>`;
            console.error('Ошибка:', err);
        });
    }

    // === CSRF Token ===
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // === Применение фильтров ===
    function applyFilters() {
        const status = document.getElementById('status-filter').value;
        const start_date = document.getElementById('start-date').value;
        const end_date = document.getElementById('end-date').value;

        const filters = { status, start_date, end_date };
        loadMyTasks(filters);
    }

    // === Добавление новой задачи ===
    function addTask() {
        const title = document.getElementById('task-title').value.trim();
        if (!title) return alert('Введите название задачи');

        authenticatedFetch('/add-task/', {
            method: 'POST',
            body: JSON.stringify({ title })
        })
        .then(res => res.json())
        .then(data => {
            if (data.error) return alert(data.error);
            document.getElementById('task-title').value = '';
            loadMyTasks();
        })
        .catch(err => console.error(err));
    }

    // === Обновление шапки (авторизация) ===
    function updateAuthHeader() {
        const token = localStorage.getItem('token');
        const authHeader = document.getElementById('auth-header');

        if (token) {
            authenticatedFetch('/api/users/update/', { method: 'GET' })
                .then(res => res.json())
                .then(data => {
                    if (data.user) {
                        authHeader.innerHTML = `
                            <span class="username">Здравствуйте, ${data.user.username}!</span>
                            <button onclick="logout()" class="btn btn-danger">Выйти</button>
                        `;
                    } else {
                        showLogin(authHeader);
                    }
                })
                .catch(() => showLogin(authHeader));
        } else {
            showLogin(authHeader);
        }
    }

    function showLogin(authHeader) {
        authHeader.innerHTML = `
            <a href="/api/login/" class="btn btn-primary">Войти</a>
        `;
    }

    function logout() {
        localStorage.removeItem('token');
        window.location.href = '/api/login/';
    }

    // === Открытие модального окна ===
    function openProfileModal(event) {
        event.preventDefault();
        authenticatedFetch('/api/users/update/', { method: 'GET' })
            .then(res => res.json())
            .then(data => {
                if (data.user) {
                    document.getElementById('modal-username').value = data.user.username || '';
                    document.getElementById('modal-email').value = data.user.email || '';
                    document.getElementById('modal-password').value = '';
                }
            })
            .catch(err => {
                alert('Ошибка загрузки данных.');
                console.error(err);
            });

        document.getElementById('profile-modal').style.display = 'flex';
    }

    // === Закрытие модального окна ===
    function closeModal() {
        document.getElementById('profile-modal').style.display = 'none';
    }

    // === Сохранение профиля ===
    window.addEventListener('DOMContentLoaded', function () {
        updateAuthHeader();

        const profileForm = document.getElementById('profile-form');
        if (profileForm) {
            profileForm.onsubmit = function (e) {
                e.preventDefault();

                const username = document.getElementById('modal-username').value.trim();
                const email = document.getElementById('modal-email').value.trim();
                const password = document.getElementById('modal-password').value;

                if (!username) return alert('Введите имя пользователя');
                if (!email) return alert('Введите email');

                const token = localStorage.getItem('token');
                if (!token) return alert('Требуется авторизация.');

                authenticatedFetch('/account/update-account/', {
                    method: 'POST',
                    body: JSON.stringify({ username, email, password })
                })
                .then(res => {
                    if (!res.ok) throw new Error('Ошибка сервера');
                    return res.json();
                })
                .then(data => {
                    if (data.success) {
                        alert('Профиль успешно обновлён!');
                        closeModal();
                        updateAuthHeader();
                    } else if (data.error) {
                        alert('Ошибка: ' + data.error);
                    }
                })
                .catch(err => {
                    alert('Ошибка: ' + (err.message || 'Сеть'));
                    console.error(err);
                });
            };
        }
    });

    // === Функции для работы с задачами и подзадачами ===

    function editTask(taskId) {
        const taskElement = document.getElementById(`card-${taskId}`);
        if (!taskElement) return;

        const strong = taskElement.querySelector('strong');
        const p = taskElement.querySelector('p');

        const title = strong ? strong.innerText : '';
        const remark = p ? p.innerText : '';

        const form = document.createElement('form');
        form.innerHTML = `
            <input type="text" value="${title}" id="edit-title-${taskId}" />
            <textarea id="edit-remark-${taskId}">${remark}</textarea>
            <button type="button" onclick="saveTask(${taskId})">Сохранить</button>
            <button type="button" onclick="cancelEdit()">Отмена</button>
        `;

        taskElement.innerHTML = '';
        taskElement.appendChild(form);
    }

    function saveTask(taskId) {
        const title = document.getElementById(`edit-title-${taskId}`).value.trim();
        const remark = document.getElementById(`edit-remark-${taskId}`).value.trim();

        if (!title) return alert("Введите название задачи");

        authenticatedFetch('/edit-task-ajax/', {
            method: 'POST',
            body: JSON.stringify({ task_id: taskId, title, remark })
        })
        .then(res => res.json())
        .then(data => {
            if (data.error) return alert(data.error);
            loadMyTasks(); // Перезагружаем доску
        })
        .catch(err => console.error(err));
    }

    function deleteTask(taskId) {
        if (!confirm("Удалить задачу?")) return;

        authenticatedFetch('/delete-task-ajax/', {
            method: 'POST',
            body: JSON.stringify({ task_id: taskId })
        })
        .then(res => res.json())
        .then(data => {
            if (data.error) return alert(data.error);
            loadMyTasks(); // Обновляем доску
        })
        .catch(err => console.error(err));
    }

    function updateTaskStatus(taskId, status) {
        authenticatedFetch('/update-task-status/', {
            method: 'POST',
            body: JSON.stringify({ task_id: taskId, new_status: status })
        })
        .then(res => res.json())
        .then(data => {
            if (data.error) return alert(data.error);
            loadMyTasks(); // Обновляем доску
        })
        .catch(err => console.error(err));
    }

    function addSubtask(taskId) {
        const input = document.getElementById(`subtask-input-${taskId}`);
        const title = input.value.trim();
        if (!title) return alert("Введите название подзадачи");

        authenticatedFetch('/add-subtask/', {
            method: 'POST',
            body: JSON.stringify({ task_id: taskId, subtask_title: title })
        })
        .then(res => res.json())
        .then(data => {
            if (data.error) return alert(data.error);
            loadMyTasks(); // Обновляем
        })
        .catch(err => console.error(err));
    }

    function editSubtask(subtaskId) {
        const subtaskElement = document.getElementById(`subtask-${subtaskId}`);
        const title = subtaskElement.querySelector('strong').innerText;

        const form = document.createElement('form');
        form.innerHTML = `
            <input type="text" value="${title}" id="edit-subtask-title-${subtaskId}" />
            <button type="button" onclick="saveSubtask(${subtaskId})">Сохранить</button>
            <button type="button" onclick="cancelEdit()">Отмена</button>
        `;

        subtaskElement.innerHTML = '';
        subtaskElement.appendChild(form);
    }

    function saveSubtask(subtaskId) {
        const title = document.getElementById(`edit-subtask-title-${subtaskId}`).value.trim();
        if (!title) return alert("Введите название");

        authenticatedFetch('/edit-subtask-ajax/', {
            method: 'POST',
            body: JSON.stringify({ subtask_id: subtaskId, title })
        })
        .then(res => res.json())
        .then(data => {
            if (data.error) return alert(data.error);
            loadMyTasks();
        })
        .catch(err => console.error(err));
    }

    function deleteSubtask(subtaskId) {
        if (!confirm("Удалить подзадачу?")) return;

        authenticatedFetch('/delete-subtask-ajax/', {
            method: 'POST',
            body: JSON.stringify({ subtask_id: subtaskId })
        })
        .then(res => res.json())
        .then(() => loadMyTasks())
        .catch(err => console.error(err));
    }

    function toggleSubtaskStatus(subtaskId, isCompleted) {
        authenticatedFetch('/toggle-subtask-ajax/', {
            method: 'POST',
            body: JSON.stringify({ subtask_id: subtaskId, is_completed: isCompleted })
        }).catch(console.error);
    }

    function takeTask(taskId) {
        authenticatedFetch('/take-task-ajax/', {
            method: 'POST',
            body: JSON.stringify({ task_id: taskId })
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                alert(`Вы взяли задачу: ${data.title}`);
                loadMyTasks();
            } else {
                alert(data.error);
            }
        })
        .catch(err => console.error(err));
    }

    function cancelEdit() {
        loadMyTasks(); // Просто перезагружаем
    }
</script>
</body>
</html>

