<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Личный кабинет</title>
    {% load static %}
    <link rel="stylesheet" href="{% static 'css/styles.css' %}">
</head>
<body>
<!-- Верхняя шапка с навигацией -->
<header class="main-header">
    <div class="nav-links">
        <a href="/" class="btn btn-secondary">Главная страница</a>
        <a href="#" onclick="showMyTasks(event)" class="btn btn-primary">Мои задачи</a>
        <a href="#" onclick="showMyDepartment(event)" class="btn btn-secondary">Моё подразделение</a>
    </div>
    <div class="user-controls" id="auth-header">
        <!-- Имя пользователя и кнопка Войти/Выйти -->
    </div>
</header>

<!-- Фильтры (скрыты до нажатия "Мои задачи") -->
<div class="filters" id="filters-section" style="display: none;">
    <form method="get">
        <label for="status-filter">Статус:</label>
        <select name="status" id="status-filter">
            <option value="">Все</option>
            {% for status in status_choices %}
                <option value="{{ status.0 }}" {% if request.GET.status == status.0 %}selected{% endif %}>
                    {{ status.1 }}
                </option>
            {% endfor %}
        </select>

        <label for="start-date">Дата начала:</label>
        <input type="date" name="start_date" id="start-date" value="{{ request.GET.start_date }}">

        <label for="end-date">Дата окончания:</label>
        <input type="date" name="end_date" id="end-date" value="{{ request.GET.end_date }}">

        <button type="button" onclick="applyFilters()">Применить</button>
    </form>
</div>

<!-- Доска задач (изначально скрыта) -->
<div class="board" id="tasks-board" style="display: none;">
    <!-- Задачи будут загружены через JS -->
</div>

<!-- Сообщение, пока задачи не загружены -->
<div id="welcome-message" style="text-align: center; margin-top: 100px; color: #777;">
    <h2>Добро пожаловать!</h2>
    <p>Нажмите <strong>"Мои задачи"</strong>, чтобы посмотреть свои задачи.</p>
</div>

<!-- Форма добавления новой задачи (тоже скрыта) -->
<div class="add-task" id="add-task-section" style="display: none;">
    <h3>Добавить задачу</h3>
    <input type="text" id="task-title" placeholder="Название задачи..." />
    <button onclick="addTask()">Добавить</button>
</div>

<script src="{% static 'js/utils.js' %}"></script>

<script>
    // === Управление отображением разделов ===
    function showMyTasks(event) {
        event.preventDefault();
        document.getElementById('welcome-message').style.display = 'none';
        document.getElementById('filters-section').style.display = 'block';
        document.getElementById('tasks-board').style.display = 'flex';
        document.getElementById('add-task-section').style.display = 'block';
        loadMyTasks(); // Загружаем задачи
    }

    function showMyDepartment(event) {
        event.preventDefault();
        alert("Функция 'Моё подразделение' пока в разработке.");
    }

    // === Загрузка задач пользователя через AJAX с фильтрами ===
    function loadMyTasks(filters = {}) {
        const board = document.getElementById('tasks-board');
        board.innerHTML = '<p style="text-align: center; width: 100%;">Загрузка задач...</p>';

        const token = localStorage.getItem('token');
        if (!token) {
            board.innerHTML = '<p style="color: red;">Ошибка: токен не найден. Войдите снова.</p>';
            return;
        }

        fetch('/account/my-tasks/', {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify(filters)
        })
        .then(response => {
            if (response.status === 401) {
                throw new Error('Неавторизован');
            }
            return response.json();
        })
        .then(data => {
            if (data.html) {
                board.innerHTML = data.html;
            } else if (data.error) {
                board.innerHTML = `<p style="color: red;">Ошибка: ${data.error}</p>`;
            }
        })
        .catch(err => {
            board.innerHTML = `<p style="color: red;">${err.message || 'Неизвестная ошибка'}</p>`;
            console.error('Ошибка загрузки задач:', err);
        });
    }

    // === Вспомогательная функция для получения CSRF-токена ===
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // === Применение фильтров ===
    function applyFilters() {
        const status = document.getElementById('status-filter').value;
        const start_date = document.getElementById('start-date').value;
        const end_date = document.getElementById('end-date').value;

        const filters = {
            status: status,
            start_date: start_date,
            end_date: end_date
        };

        loadMyTasks(filters); // Передаём фильтры
    }

    // === Добавление задачи ===
    function addTask() {
        const title = document.getElementById('task-title').value.trim();
        if (!title) return alert('Введите название задачи');

        authenticatedFetch('/add-task/', {
            method: 'POST',
            body: JSON.stringify({ title: title })
        })
        .then(res => res.json())
        .then(data => {
            if (data.error) return alert(data.error);
            document.getElementById('task-title').value = '';
            loadMyTasks(); // Обновить список
        })
        .catch(err => console.error(err));
    }

    // === Обновление шапки (авторизация) ===
    function updateAuthHeader() {
        const token = localStorage.getItem('token');
        const authHeader = document.getElementById('auth-header');

        if (token) {
            authenticatedFetch('/api/users/update/', {
                method: 'GET'
            })
            .then(res => res.json())
            .then(data => {
                if (data.user) {
                    authHeader.innerHTML = `
                        <span class="username">Здравствуйте, ${data.user.username}!</span>
                        <button onclick="logout()" class="btn btn-danger">Выйти</button>
                    `;
                } else {
                    showLogin(authHeader);
                }
            })
            .catch(() => showLogin(authHeader));
        } else {
            showLogin(authHeader);
        }
    }

    function showLogin(authHeader) {
        authHeader.innerHTML = `
            <a href="/api/login/" class="btn btn-primary">Войти</a>
        `;
    }

    function logout() {
        localStorage.removeItem('token');
        window.location.href = '/api/login/';
    }

    // === Инициализация при загрузке страницы ===
    window.addEventListener('DOMContentLoaded', function () {
        updateAuthHeader();
    });
</script>

</body>
</html>
