<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Kanban Board</title>
    {% load static %}
    <link rel="stylesheet" href="{% static 'css/styles.css' %}">
</head>
<body>
<!-- Верхняя шапка -->
<header class="main-header">
    <div class="logo">
        <a href="/account/" class="btn btn-secondary">Личный кабинет</a>
        <a href="/company/" class="btn btn-secondary">Компания</a>
    </div>
    <div class="user-controls" id="auth-header">
        <!-- Имя пользователя и кнопка Войти/Выйти будут загружены сюда -->
    </div>
</header>

<!-- Фильтры -->
<div class="filters" id="filters-section">
    <form method="get">
        <label for="status-filter">Статус:</label>
        <select name="status" id="status-filter">
            <option value="">Все</option>
            {% for status in status_choices %}
                <option value="{{ status.0 }}" {% if request.GET.status == status.0 %}selected{% endif %}>
                    {{ status.1 }}
                </option>
            {% endfor %}
        </select>

        <label for="start-date">Дата начала:</label>
        <input type="date" name="start_date" id="start-date" value="{{ request.GET.start_date }}">

        <label for="end-date">Дата окончания:</label>
        <input type="date" name="end_date" id="end-date" value="{{ request.GET.end_date }}">

        <button type="button" onclick="applyFilters()">Применить</button>
    </form>
</div>

<br>

<!-- Доска задач -->
<div class="board">
    {% for task in tasks %}
    <div class="column" id="task-{{ task.id }}">
        <h3>{{ task.get_status_display }}</h3>
        <div class="card" id="card-{{ task.id }}">
            <strong>{{ task.title }}</strong>
            <p>{{ task.remark|default:'' }}</p>
            <p><small>Создано: {{ task.date_start }}</small></p>
            <p>
                <small class="{% if task.date_end and task.date_end < today and task.status != 'done' %}overdue{% endif %}">
                    Окончание: {{ task.date_end|default:"—" }}
                </small>
            </p>
            <p><small>Назначил: {{ task.customer.username|default:"Нет" }}</small></p>
            <p><small>Исполнитель: {{ task.employee.username|default:"Нет" }}</small></p>
            <button onclick="editTask({{ task.id }})">Edit</button>
            <button onclick="deleteTask({{ task.id }})">Delete</button>
            <select onchange="updateTaskStatus({{ task.id }}, this.value)">
                <option value="todo" {% if task.status == 'todo' %}selected{% endif %}>Todo</option>
                <option value="in_progress" {% if task.status == 'in_progress' %}selected{% endif %}>In Progress</option>
                <option value="done" {% if task.status == 'done' %}selected{% endif %}>Done</option>
            </select>
            {% if not task.employee %}
                <button onclick="takeTask({{ task.id }})">Взять задачу</button>
            {% endif %}
        </div>

        <!-- Подзадачи -->
        {% for subtask in task.subtasks.all %}
        <div class="card" id="subtask-{{ subtask.id }}">
            <strong>{{ subtask.title }}</strong>
            <p></p>
            <button onclick="editSubtask({{ subtask.id }})">Edit</button>
            <button onclick="deleteSubtask({{ subtask.id }})">Delete</button>
            <label>
                <input type="checkbox" {% if subtask.is_accomplished %}checked{% endif %} onchange="toggleSubtaskStatus({{ subtask.id }}, this.checked)">
                Accomplished
            </label>
        </div>
        {% endfor %}

        <!-- Форма добавления подзадач -->
        <div class="add-card">
            <input type="text" id="subtask-input-{{ task.id }}" placeholder="New subtask..." />
            <button onclick="addSubtask({{ task.id }})">Add Subtask</button>
        </div>
    </div>
    {% endfor %}
</div>

<!-- Форма добавления новой задачи -->
<div class="add-task">
    <h3>Add New Task</h3>
    <input type="text" id="task-title" placeholder="Task title..." />
    <button onclick="addTask()">Add Task</button>
</div>

<script src="{% static 'js/utils.js' %}"></script>

<script>
    // Обновление шапки с авторизацией
    function updateAuthHeader() {
        const token = localStorage.getItem('token');
        const authHeader = document.getElementById('auth-header');

        if (token) {
            authenticatedFetch('/api/users/update/', {
                method: 'GET'
            })
            .then(res => res.json())
            .then(data => {
                if (data.user && data.user.email) {
                    authHeader.innerHTML = `
                        <span class="username">Здравствуйте, ${data.user.username}!</span>
                        <button onclick="logout()" class="btn btn-danger">Выйти</button>
                    `;
                } else {
                    authHeader.innerHTML = `
                        <a href="/api/login/" class="btn btn-primary">Войти</a>
                    `;
                }
            })
            .catch(() => {
                authHeader.innerHTML = `
                    <a href="/api/login/" class="btn btn-primary">Войти</a>
                `;
            });
        } else {
            authHeader.innerHTML = `
                <a href="/api/login/" class="btn btn-primary">Войти</a>
            `;
        }
    }

    function logout() {
        localStorage.removeItem('token');
        window.location.href = '/api/login/';
    }

    // Вызов при загрузке страницы
    window.addEventListener('DOMContentLoaded', function () {
        updateAuthHeader();
    });

    // Добавление новой задачи
    function addTask() {
        const title = document.getElementById('task-title').value.trim();
        if (!title) return;

        authenticatedFetch('/add-task/', {
            method: 'POST',
            body: JSON.stringify({ title: title })
        }).then(res => res.json())
          .then(data => {
              if (data.error) {
                  alert(data.error);
                  return;
              }
              const column = document.createElement('div');
              column.className = 'column';
              column.id = `task-${data.id}`;
              column.innerHTML = `<h3>Todo</h3>${data.html}<div class="add-card"><input type="text" id="subtask-input-${data.id}" placeholder="New subtask..." /><button onclick="addSubtask(${data.id})">Add Subtask</button></div>`;
              document.querySelector('.board').appendChild(column);
              document.getElementById('task-title').value = '';
          })
          .catch(err => console.error(err));
    }

    function addSubtask(taskId) {
        const input = document.getElementById(`subtask-input-${taskId}`);
        const title = input.value.trim();
        if (!title) return;

        authenticatedFetch('/add-subtask/', {
            method: 'POST',
            body: JSON.stringify({ task_id: taskId, subtask_title: title })
        }).then(res => res.json())
          .then(data => {
              if (data.error) {
                  alert(data.error);
                  return;
              }
              const column = document.getElementById(`task-${taskId}`);
              const card = document.createElement('div');
              card.innerHTML = data.html;
              column.insertBefore(card, column.querySelector('.add-card'));
              input.value = '';
          })
          .catch(err => console.error(err));
    }

    function updateTaskStatus(taskId, status) {
        authenticatedFetch('/update-task-status/', {
            method: 'POST',
            body: JSON.stringify({ task_id: taskId, new_status: status })
        }).then(res => res.json())
          .then(data => {
              if (data.error) {
                  alert(data.error);
                  return;
              }

              const taskElement = document.getElementById(`card-${taskId}`);
              const select = taskElement.querySelector('select');
              select.innerHTML = `
                  <option value="todo" ${data.status === 'todo' ? 'selected' : ''}>Todo</option>
                  <option value="in_progress" ${data.status === 'in_progress' ? 'selected' : ''}>In Progress</option>
                  <option value="done" ${data.status === 'done' ? 'selected' : ''}>Done</option>
              `;
          })
          .catch(err => console.error(err));
    }

    function deleteTask(taskId) {
        if (confirm("Delete this task?")) {
            authenticatedFetch('/delete-task-ajax/', {
                method: 'POST',
                body: JSON.stringify({ task_id: taskId })
            }).then(res => res.json())
              .then(data => {
                  if (data.error) {
                      alert(data.error);
                      return;
                  }
                  const taskElement = document.getElementById(`task-${taskId}`);
                  if (taskElement) taskElement.remove();
              })
              .catch(err => console.error('Error:', err));
        }
    }

    function deleteSubtask(subtaskId) {
        if (confirm("Delete this subtask?")) {
            authenticatedFetch('/delete-subtask-ajax/', {
                method: 'POST',
                body: JSON.stringify({ subtask_id: subtaskId })
            }).then(res => res.json())
              .then(() => {
                  const subtaskElement = document.getElementById(`subtask-${subtaskId}`);
                  if (subtaskElement) subtaskElement.remove();
              })
              .catch(err => console.error(err));
        }
    }

    function toggleSubtaskStatus(subtaskId, isCompleted) {
        authenticatedFetch('/toggle-subtask-ajax/', {
            method: 'POST',
            body: JSON.stringify({
                subtask_id: subtaskId,
                is_completed: isCompleted.toString()
            })
        }).catch(err => console.error(err));
    }

    function editTask(taskId) {
    const taskElement = document.getElementById(`card-${taskId}`);
    if (!taskElement) return;

    const strong = taskElement.querySelector('strong');
    const p = taskElement.querySelector('p');
    const dateEndText = Array.from(taskElement.querySelectorAll('small'))
                            .find(el => el.textContent.includes('Окончание:'))?.textContent
                            .replace('Окончание: ', '');

    const title = strong ? strong.innerText : '';
    const remark = p ? p.innerText : '';
    const dateEnd = dateEndText && dateEndText !== '—' ? dateEndText.split(' ')[0] : ''; // Извлекаем дату

    const form = document.createElement('form');
    form.innerHTML = `
        <input type="text" value="${title}" id="edit-title-${taskId}" />
        <textarea id="edit-remark-${taskId}">${remark}</textarea>
        <label>Дата окончания: <input type="date" id="edit-date-end-${taskId}" value="${dateEnd}" /></label>
        <button type="button" onclick="saveTask(${taskId})">Save</button>
        <button type="button" onclick="cancelEdit()">Cancel</button>
    `;

    taskElement.innerHTML = '';
    taskElement.appendChild(form);
}


    function saveTask(taskId) {
    const title = document.getElementById(`edit-title-${taskId}`).value.trim();
    const remark = document.getElementById(`edit-remark-${taskId}`).value.trim();
    const dateEnd = document.getElementById(`edit-date-end-${taskId}`).value || null;

    if (!title) return alert("Title is required");

    authenticatedFetch('/edit-task-ajax/', {
        method: 'POST',
        body: JSON.stringify({
            task_id: taskId,
            title: title,
            remark: remark,
            end_date: dateEnd
        })
    }).then(res => res.json())
      .then(data => {
          if (data.error) {
              alert(data.error);
              return;
          }

          const taskElement = document.getElementById(`card-${taskId}`);
          taskElement.innerHTML = `
              <strong>${data.title}</strong>
              <p>${data.remark || ''}</p>
              <p><small>Создано: ${data.date_start}</small></p>
              <p><small>Окончание: ${data.date_end || "—"}</small></p>
              <p><small>Исполнитель: ${data.employee || "Нет"}</small></p>
              <button onclick="deleteTask(${taskId})">Delete</button>
              <button onclick="editTask(${taskId})">Edit</button>
              <select onchange="updateTaskStatus(${taskId}, this.value)">
                  <option value="todo" ${data.status === 'todo' ? 'selected' : ''}>Todo</option>
                  <option value="in_progress" ${data.status === 'in_progress' ? 'selected' : ''}>In Progress</option>
                  <option value="done" ${data.status === 'done' ? 'selected' : ''}>Done</option>
              </select>
              ${data.employee ? '' : `<button onclick="takeTask(${taskId})">Взять задачу</button>`}
          `;
      })
      .catch(err => console.error(err));
}


    function cancelEdit() {
        location.reload(); // Перезагрузка страницы
    }

    function editSubtask(subtaskId) {
        const subtaskElement = document.getElementById(`subtask-${subtaskId}`);
        if (!subtaskElement) return;

        const title = subtaskElement.querySelector('strong').innerText;

        const form = document.createElement('form');
        form.innerHTML = `
            <input type="text" value="${title}" id="edit-subtask-title-${subtaskId}" />
            <button type="button" onclick="saveSubtask(${subtaskId})">Save</button>
            <button type="button" onclick="cancelEdit()">Cancel</button>
        `;

        subtaskElement.innerHTML = '';
        subtaskElement.appendChild(form);
    }

    function saveSubtask(subtaskId) {
        const title = document.getElementById(`edit-subtask-title-${subtaskId}`).value.trim();

        if (!title) return alert("Title is required");

        authenticatedFetch('/edit-subtask-ajax/', {
            method: 'POST',
            body: JSON.stringify({
                subtask_id: subtaskId,
                title: title
            })
        }).then(res => res.json())
          .then(data => {
              if (data.error) {
                  alert(data.error);
                  return;
              }

              const subtaskElement = document.getElementById(`subtask-${subtaskId}`);
              subtaskElement.innerHTML = `
                  <strong>${data.title}</strong>
                  <p></p>
                  <button onclick="editSubtask(${subtaskId})">Edit</button>
                  <button onclick="deleteSubtask(${subtaskId})">Delete</button>
                  <label>
                      <input type="checkbox" ${data.is_accomplished ? 'checked' : ''} onchange="toggleSubtaskStatus(${subtaskId}, this.checked)">
                      Accomplished
                  </label>
              `;
          })
          .catch(err => console.error(err));
    }

    function takeTask(taskId) {
        authenticatedFetch('/take-task-ajax/', {
            method: 'POST',
            body: JSON.stringify({ task_id: taskId })
        }).then(res => res.json())
          .then(data => {
              if (data.success) {
                  const card = document.getElementById(`card-${taskId}`);
                  if (card) {
                      card.innerHTML += `<p><small>Исполнитель: ${data.username}</small></p>`;
                      const takeBtn = card.querySelector('button[onclick*="takeTask"]');
                      if (takeBtn) takeBtn.remove();
                  }
              } else {
                  alert(data.error);
              }
          })
          .catch(err => console.error(err));
    }
    function applyFilters() {
    const status = document.getElementById('status-filter').value;
    const start_date = document.getElementById('start-date').value;
    const end_date = document.getElementById('end-date').value;

    // Создаём URL с параметрами
    const params = new URLSearchParams();
    if (status) params.append('status', status);
    if (start_date) params.append('start_date', start_date);
    if (end_date) params.append('end_date', end_date);

    // Перезагружаем страницу с фильтрами
    window.location.href = window.location.pathname + '?' + params.toString();
}
</script>

</body>
</html>